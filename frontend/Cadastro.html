<html>

<head>
    <title>Biblioteca</title>
</head>

<h1> Cadastro de Livros </h1>

<body>
    <h3> Dados de Livro </h3>
    <img id="capaimg" style="float: right;" src="default.png" alt="capa">
    <div class="form">
        <label for="id">ID: </label> <input id="id" type="number" value="0">
        <button onclick="getLivroId()">Consultar Dados por ID</button> <br>
        <label for="nome">Título: </label> <input id="nome" type="text"> <br>
        <label for="datalancamento">Data de Lançamento: </label> <input datalancamento="datalancamento"
            id="datalancamento" type="date"> <br>
        <label for="autor">Autor(a): </label> <input autor="autor" id="autor" type="text"> <br>
        <label for="editora">Editora: </label> <input editora="editora" id="editora" type="text"> <br>
        <label for="numpags">Número de Páginas: </label> <input numpags="numpags" id="numpags" type="number" value="0">
        <br>
        <label for="capa">Capa: </label> <input id="capa" type="file"> <br>
        <label for="extensão">Extensão: </label> <input id="extensao" type="text" disabled="disabled"> <br>
        <button onclick="postLivro()">Cadastrar Livro</button>
        <button onclick="postCapa()">Cadastrar Capa</button> <br>
        <button onclick="updateLivro()">Atualizar Livro</button>
        <button onclick="deleteLivro()">Deletar Dados</button>
        <button onclick="limpaCampos()">Limpar campos</button> <br>
    </div>
    <h3> Consulta à Biblioteca </h3>
    <div class="links">
        <a href="http://localhost:8081/livros" target="_blank">Consultar todos os livros</a>
        <em> / </em>
        <a href="http://localhost:8081/relatorio" target="_blank">Gerar relatório</a>
    </div>
    <link rel="stylesheet" href="style.css">
</body>

<script>

    async function postLivro() {
        const id = document.getElementById("id").value
        const nome = document.getElementById("nome").value
        const datalancamento = document.getElementById("datalancamento").value
        const autor = document.getElementById("autor").value
        const editora = document.getElementById("editora").value
        const numpags = document.getElementById("numpags").value
        var contaid = verificaId(id, 0);
        var contaerro = verificaPostPut(id, numpags, 0);
        if (contaid > 0) {
            return;
        }
        if (contaerro > 0) {
            return;
        }
        let json = { id: id, nome: nome, datalancamento: datalancamento, autor: autor, editora: editora, numpags: numpags }
        const url = 'http://localhost:8081/livros';
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        };
        await fetch(url, options)
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => { throw new Error(text) })
                }
                else {
                    return res.json();
                }
            })
            .then(function (json) {
                limpaCampos();
                alert("Livro cadastrado com sucesso!");
            })
            .catch(error => {
                alert(error);
            });
    }

    async function postCapa() {
        const url = 'http://localhost:8081/livros/capa/' + document.getElementById("id").value;
        var contaid = verificaId(id, 0);
        if (contaid > 0) {
            return;
        }
        const formData = new FormData();
        const capaFile = document.getElementById("capa").files[0];
        formData.append('capa', capaFile);
        const options = {
            method: 'POST',
            body: formData,
        };

        await fetch(url, options)
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => { throw new Error(text) })
                }
            })
            .then(function (json) {
                alert("Capa cadastrada com sucesso!");
            })
            .catch(error => {
                alert(error);
            });
    }

    async function getLivroId() {
        const nome = document.getElementById("nome");
        const datalancamento = document.getElementById("datalancamento");
        const autor = document.getElementById("autor");
        const editora = document.getElementById("editora");
        const numpags = document.getElementById("numpags");
        const url = `http://localhost:8081/livros/` + document.getElementById("id").value;
        var contaid = verificaId(document.getElementById("id").value, 0);
        if (contaid > 0) {
            return;
        }
        try {
            await fetch(url)
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => { throw new Error(text) })
                    }
                    else {
                        return res.json();
                    }
                })
                .then(function (json) {
                    nome.value = JSON.stringify(json.nome).replace(/^"|"$/g, '');
                    datalancamento.value = json.datalancamento;
                    autor.value = JSON.stringify(json.autor).replace(/^"|"$/g, '');
                    editora.value = JSON.stringify(json.editora).replace(/^"|"$/g, '');
                    numpags.value = JSON.stringify(json.numpags);
                    getCapaId();
                })
                .catch(error => {
                    alert(error);
                });
        } catch (error) {
            console.log(error.message);
        }
    }

    async function getCapaId() {
        const capaFile = document.getElementById("capa").files[0];
        const capaimg = document.getElementById("capaimg");
        const url = `http://localhost:8081/livros/capa/` + document.getElementById("id").value;
        const options = {
            method: 'GET',
            responseType: 'blob',
        };
        try {
            await fetch(url, options)
                .then(res => {
                    console.log(res);
                    if (!res.ok) {
                        return res.text().then(text => { throw new Error(text) })
                    }
                    else {
                        return res.blob();
                    }
                })
                .then(function (arquivo) {
                    const objectURL = URL.createObjectURL(arquivo);
                    capaimg.src = objectURL;
                    getExtensao();
                })
                .catch(error => {
                    limpaCapa();
                    alert(error);
                });
        } catch (error) {
            console.log(error.message);
        }
    }

    async function getExtensao() {
        const extensao = document.getElementById("extensao");
        const capa = document.getElementById("capa");
        const url = `http://localhost:8081/livros/capa/details/` + document.getElementById("id").value;
        try {
            await fetch(url)
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => { throw new Error(text) })
                    }
                    else {
                        return res.json();
                    }
                })
                .then(function (data) {
                    extensao.value = "." + data.extensao;
                })
                .catch(error => {
                    limpaCapa();
                    alert(error);
                });
        } catch (error) {
            console.log(error.message);
        }
    }

    async function updateLivro() {
        const nome = document.getElementById("nome").value;
        const datalancamento = document.getElementById("datalancamento").value;
        const autor = document.getElementById("autor").value;
        const editora = document.getElementById("editora").value;
        const numpags = document.getElementById("numpags").value;
        let json = { nome: nome, datalancamento: datalancamento, autor: autor, editora: editora, numpags: numpags }
        var contaid = verificaId(document.getElementById("id").value, 0);
        var contaerro = verificaPostPut(document.getElementById("id").value, numpags, 0);
        if (contaid > 0) {
            return;
        }
        if (contaerro > 0) {
            return;
        }
        const url = `http://localhost:8081/livros/` + document.getElementById("id").value;
        const options = {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        };
        try {
            await fetch(url, options)
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => { throw new Error(text) })
                    }
                })
                .then(function (json) {
                    alert("Livro atualizado com sucesso!");
                    limpaCampos();
                })
                .catch(error => {
                    alert(error);
                });
        } catch (error) {
            console.log(error.message);
        }
    }

    async function deleteLivro() {
        const url = `http://localhost:8081/livros/` + document.getElementById("id").value;
        const options = {
            method: 'DELETE'
        };
        var contaid = verificaId(document.getElementById("id").value, 0);
        if (contaid > 0) {
            return;
        }
        try {
            await fetch(url, options)
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => { throw new Error(text) })
                    }
                })
                .then(function (json) {
                    limpaCampos();
                    alert("Livro deletado com sucesso!");
                })
                .catch(error => {
                    alert(error);
                });
        } catch (error) {
            console.log(error.message);
        }
    }

    function limpaCampos() {
        document.getElementById("id").value = 0;
        document.getElementById("nome").value = null;
        document.getElementById("datalancamento").value = null;
        document.getElementById("autor").value = null;
        document.getElementById("editora").value = null;
        document.getElementById("numpags").value = 0;
        limpaCapa();
    }

    function limpaCapa() {
        document.getElementById("capa").value = null;
        document.getElementById("extensao").value = null;
        capaimg.src = "default.png";
    }

    function verificaId(id, contaid) {
        if (!id) {
            alert("Campo 'ID' é de preenchimento obrigatório!");
            contaid = contaid + 1;
        }
        return contaid;
    }

    function verificaPostPut(id, numpags, contaerro) {
        if (id == 0 || id < 0) {
            alert("Campo 'ID' não pode ser nulo / negativo!");
            contaerro = contaerro + 1;
        }
        if (numpags < 0) {
            alert("Campo 'Número de Páginas' não pode ser negativo!");
            contaerro = contaerro + 1;
        }
        return contaerro;
    }

</script>