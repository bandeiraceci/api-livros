<html>

<head>
    <title>Biblioteca</title>
</head>

<h1> Cadastro de Livros </h1>

<body>
    <h3> Dados de Livro </h3>
    <label for="id">ID: </label> <input id="id" type="id">
    <button type="button" onclick="getLivroId()">Consultar Dados por ID</button> <br>
    <img id="capaimg" style="float: right;" height="300" alt="capa">
    <label for="nome">Título: </label> <input id="nome" type="text"> <br>
    <label for="datalancamento">Data de Lançamento: </label> <input datalancamento="datalancamento" id="datalancamento"
        type="date"> <br>
    <label for="autor">Autor(a): </label> <input autor="autor" id="autor" type="text"> <br>
    <label for="editora">Editora: </label> <input editora="editora" id="editora" type="text"> <br>
    <label for="numpags">Número de Páginas: </label> <input numpags="numpags" id="numpags" type="number"> <br>
    <label for="capa">Capa: </label> <input id="capa" type="file"> <br>
    <label for="extensão">Extensão: </label> <input id="extensao" type="text" disabled="disabled"> <br>
    <button onclick="postLivro()">Cadastrar Livro</button>
    <button onclick="postCapa()">Cadastrar Capa</button> <br>
    <button onclick="updateLivro()">Atualizar Livro</button>
    <button onclick="deleteLivro()">Deletar Dados</button>
    <button onclick="limpaCampos()">Limpar campos</button> <br>
    <h3> Consulta à Biblioteca </h3>
    <a href="http://localhost:8081/livros">Consultar todos os livros</a>
    <em> / </em>
    <a href="http://localhost:8081/relatorio">Gerar relatório</a>
    <link rel="stylesheet" href="style.css">
</body>

<script>

    async function postLivro() {
        const id = document.getElementById("id").value
        const nome = document.getElementById("nome").value
        const datalancamento = document.getElementById("datalancamento").value
        const autor = document.getElementById("autor").value
        const editora = document.getElementById("editora").value
        const numpags = document.getElementById("numpags").value
        if (!id) {
            alert("Campo 'ID' é de preenchimento obrigatório!");
            return;
        }
        let json = { id: id, nome: nome, datalancamento: datalancamento, autor: autor, editora: editora, numpags: numpags }
        const url = 'http://localhost:8081/livros';
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        };
        /* try { */
        await fetch(url, options).then((resposta) => {
            console.log("then: ", resposta);
            limpaCampos();
            alert("Livro cadastrado com sucesso!");
        }).catch(erro => {
            console.log("erro: ", erro);
        });
        /* console.log(response);
        if (!response.ok) {
            alert("Erro ao cadastrar livro");
        } else {
            alert("Livro cadastrado com sucesso!");
            limpaCampos();
        } */
        /*         } catch (error) {
                    console.log("erro: ", error);
                } */
    }

    async function postCapa() {
        const url = 'http://localhost:8081/livros/capa/' + document.getElementById("id").value;
        const formData = new FormData();
        const capaFile = document.getElementById("capa").files[0];
        formData.append('capa', capaFile);
        const options = {
            method: 'POST',
            body: formData,
        };
        try {
            const response = await fetch(url, options)
            if (!response.ok) {
                alert("Erro ao cadastrar capa");
            } else {
                alert("Capa cadastrada com sucesso!");
            }
        } catch (error) {
            console.log(error.message);
        }
    }

    async function getLivroId() {
        const nome = document.getElementById("nome");
        const datalancamento = document.getElementById("datalancamento");
        const autor = document.getElementById("autor");
        const editora = document.getElementById("editora");
        const numpags = document.getElementById("numpags");
        const url = `http://localhost:8081/livros/` + document.getElementById("id").value;
        if (!document.getElementById("id").value) {
            alert("Campo 'ID' é de preenchimento obrigatório!");
            return;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                alert("Erro ao consultar livro");
            } else {
                const data = await response.json();
                console.log(data);
                nome.value = JSON.stringify(data.nome).replace(/^"|"$/g, '');
                datalancamento.value = data.datalancamento;
                autor.value = JSON.stringify(data.autor).replace(/^"|"$/g, '');
                editora.value = JSON.stringify(data.editora).replace(/^"|"$/g, '');
                numpags.value = JSON.stringify(data.numpags);
                getCapaId();
                // pega extensão
            }
        } catch (error) {
            console.log(error.message);
        }
    }

    async function getCapaId() {
        const capaFile = document.getElementById("capa").files[0];
        const capaimg = document.getElementById("capaimg");
        const url = `http://localhost:8081/livros/capa/` + document.getElementById("id").value;
        const options = {
            method: 'GET',
            responseType: 'blob',
        };

        try {
            await fetch(url, options).then((response) => response.blob()).then((arquivo) => {
                const objectURL = URL.createObjectURL(arquivo);
                capaimg.src = objectURL;
            });
            if (!response.ok) {
                alert("Erro ao consultar capa");
            }
        } catch (error) {
            console.log(error.message);
        }
    }

    async function updateLivro() {
        const nome = document.getElementById("nome").value;
        const datalancamento = document.getElementById("datalancamento").value;
        const autor = document.getElementById("autor").value;
        const editora = document.getElementById("editora").value;
        const numpags = document.getElementById("numpags").value;
        if (!datalancamento) {
            alert("Campo 'Data de Lançamento' é de preenchimento obrigatório!");
            return;
        }
        let json = { nome: nome, datalancamento: datalancamento, autor: autor, editora: editora, numpags: numpags }
        const url = `http://localhost:8081/livros/` + document.getElementById("id").value;
        const options = {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        };
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                alert(response);
            } else {
                alert("Livro atualizado com sucesso!");
                limpaCampos();
            }
        } catch (error) {
            console.log(error.message);
        }
    }

    async function deleteLivro() {
        const url = `http://localhost:8081/livros/` + document.getElementById("id").value;
        const options = {
            method: 'DELETE'
        };
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                alert("Erro ao deletar livro");
            } else {
                alert("Livro deletado com sucesso!");
                limpaCampos();
            }
        } catch (error) {
            console.log(error.message);
            alert(error.message);
        }
    }

    function limpaCampos() {
        document.getElementById("id").value = null;
        document.getElementById("nome").value = null;
        document.getElementById("datalancamento").value = null;
        document.getElementById("autor").value = null;
        document.getElementById("editora").value = null;
        document.getElementById("numpags").value = null;
        document.getElementById("capa").value = null;
        document.getElementById("extensao").value = null;
    }

</script>